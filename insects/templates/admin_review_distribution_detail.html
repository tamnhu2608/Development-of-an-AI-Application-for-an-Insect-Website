{% extends 'template_v2.html' %}
{% load static %}

{% block title %}Xét duyệt vị trí phân bố - Chi tiết{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'distribution_map' %}">Bản đồ phân bố</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'admin_review_distribution' %}">Quản lý vị trí</a></li>
                    <li class="breadcrumb-item active">Chi tiết vị trí #{{ distribution.id }}</li>
                </ol>
            </nav>
            
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Xét duyệt vị trí phân bố - Chi tiết
                    </h4>
                </div>
                
                <div class="card-body">
                    <!-- Thông tin cơ bản -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2">Thông tin cơ bản</h5>
                            <table class="table table-sm">
                                <tr>
                                    <th width="150">Loài côn trùng:</th>
                                    <td>
                                        <a href="{% url 'detail' distribution.species.slug %}" target="_blank" class="text-decoration-none">
                                            <strong>{{ distribution.species.name }}</strong>
                                        </a>
                                        <small class="text-muted d-block">{{ distribution.species.ename }}</small>
                                        
                                    </td>
                                </tr>
                                <tr>
                                    <th>Khu vực:</th>
                                    <td>{{ distribution.region.name|default:"Không xác định" }}</td>
                                </tr>
                                <tr>
                                    <th>Tọa độ:</th>
                                    <td>
                                        <span class="badge bg-info">{{ distribution.latitude }}, {{ distribution.longitude }}</span>
                                        <a href="https://maps.google.com/?q={{ distribution.latitude }},{{ distribution.longitude }}" 
                                           target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                            <i class="fas fa-external-link-alt"></i> Xem trên Google Maps
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Ngày quan sát:</th>
                                    <td>{{ distribution.observation_date|date:"d/m/Y"|default:"Không có" }}</td>
                                </tr>
                                <tr>
                                    <th>Người đóng góp:</th>
                                    <td>
                                        {{ distribution.created_by.username }}
                                        <small class="text-muted d-block">{{ distribution.created_by.email|default:"" }}</small>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Thời gian đóng góp:</th>
                                    <td>{{ distribution.created_at|date:"d/m/Y H:i:s" }}</td>
                                </tr>
                                <tr>
                                    <th>Ghi chú:</th>
                                    <td>{{ distribution.note|default:"Không có"|linebreaks }}</td>
                                </tr>
                                <tr>
                                    <th>Trạng thái:</th>
                                    <td>
                                        {% if distribution.status == 'pending' %}
                                            <span class="badge bg-warning">Chờ duyệt</span>
                                        {% elif distribution.status == 'expert_approved' %}
                                            <span class="badge bg-info">Đã duyệt bởi chuyên gia</span>
                                        {% elif distribution.status == 'admin_approved' %}
                                            <span class="badge bg-success">Đã duyệt bởi admin</span>
                                        {% else %}
                                            <span class="badge bg-danger">Đã từ chối</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if distribution.gps_from_image %}
                                <tr>
                                    <th>Nguồn GPS:</th>
                                    <td>
                                        <span class="badge bg-success">
                                            <i class="fas fa-camera"></i> Từ ảnh
                                        </span>
                                    </td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2">Hình ảnh quan sát</h5>
                            {% if distribution.observation_image %}
                                <div class="text-center">
                                    <img src="{{ distribution.observation_image.url }}" 
                                         class="img-fluid rounded border shadow" 
                                         alt="Ảnh quan sát"
                                         style="max-height: 300px; cursor: pointer;"
                                         onclick="window.open('{{ distribution.observation_image.url }}', '_blank')">
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-image"></i> 
                                            Ảnh từ người đóng góp
                                            {% if distribution.gps_from_image %}
                                                <span class="badge bg-info ms-2">GPS từ ảnh</span>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-secondary ms-2" 
                                                    onclick="window.open('{{ distribution.observation_image.url }}', '_blank')">
                                                <i class="fas fa-expand"></i> Phóng to
                                            </button>
                                        </small>
                                    </div>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Không có hình ảnh đính kèm
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Bounding Boxes nếu có ảnh -->
                    {% if distribution.observation_image %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-vector-square me-2"></i>Bounding Boxes</h5>
                                    <div class="mt-1">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Nhãn BBox tự động là: <strong class="text-primary">{{ distribution.species.eng_name }}</strong>
                                        </small>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="image-container" class="position-relative mb-3">
                                        <canvas id="bbox-canvas" class="border rounded shadow-sm"></canvas>
                                        <div id="bbox-toolbar" class="mt-2">
                                            <button id="add-bbox" class="btn btn-sm btn-primary">
                                                <i class="fas fa-plus"></i> Thêm BBox
                                            </button>
                                            <button id="clear-bboxes" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i> Xóa tất cả
                                            </button>
                                            <button id="save-bboxes" class="btn btn-sm btn-success">
                                                <i class="fas fa-save"></i> Lưu BBoxes
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="bbox-list" class="mt-3">
                                        <h6>Danh sách Bounding Boxes:</h6>
                                        <div id="bbox-items" class="list-group"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Lịch sử xét duyệt -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Lịch sử xét duyệt</h5>
                                </div>
                                <div class="card-body">
                                    {% if review_logs %}
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Thời gian</th>
                                                        <th>Người duyệt</th>
                                                        <th>Vai trò</th>
                                                        <th>Hành động</th>
                                                        <th>Ghi chú</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for log in review_logs %}
                                                    <tr>
                                                        <td>{{ log.created_at|date:"d/m/Y H:i:s" }}</td>
                                                        <td>{{ log.reviewer.username }}</td>
                                                        <td>
                                                            {% if log.role == 'expert' %}
                                                                <span class="badge bg-info">Chuyên gia</span>
                                                            {% else %}
                                                                <span class="badge bg-warning">Admin</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if log.action == 'approve' %}
                                                                <span class="badge bg-success">Đồng ý</span>
                                                            {% elif log.action == 'reject' %}
                                                                <span class="badge bg-danger">Từ chối</span>
                                                            {% else %}
                                                                <span class="badge bg-secondary">{{ log.action }}</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ log.comment|default:"-"|linebreaks }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> Chưa có lịch sử xét duyệt
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form xét duyệt -->
                    {% if distribution.status == 'expert_approved' and not already_reviewed %}
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Xét duyệt vị trí</h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" id="review-form">
                                        {% csrf_token %}
                                        
                                        <div class="mb-3">
                                            <label for="comment" class="form-label">Ghi chú:</label>
                                            <textarea class="form-control" id="comment" name="comment" 
                                                      rows="3" placeholder="Nhập ghi chú nếu cần..."></textarea>
                                            <small class="text-muted">* Bắt buộc khi từ chối</small>
                                        </div>
                                        
                                        <div class="d-flex gap-2">
                                            <button type="submit" name="action" value="approve" 
                                                    class="btn btn-success btn-lg flex-fill">
                                                <i class="fas fa-check me-2"></i>Chấp nhận
                                            </button>
                                            <button type="submit" name="action" value="reject" 
                                                    class="btn btn-danger btn-lg flex-fill"
                                                    onclick="return confirmReject()">
                                                <i class="fas fa-times me-2"></i>Từ chối
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif already_reviewed %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Bạn đã xét duyệt vị trí này rồi. Không thể duyệt lại.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
#bbox-canvas {
    max-width: 100%;
    cursor: crosshair;
    background-color: #f8f9fa;
}
.bbox-item {
    cursor: pointer;
}
.bbox-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
// Biến global
let canvas;
let bboxes = JSON.parse('{{ bboxes_json|escapejs }}' || '[]');
let currentImage = null;
// QUAN TRỌNG: Lấy tên thường gọi tiếng Anh từ trường eng_name
let speciesLabel = '{{ distribution.species.eng_name|escapejs }}';

// Khởi tạo canvas
document.addEventListener('DOMContentLoaded', function() {
    {% if distribution.observation_image %}
    initCanvas();
    {% endif %}
});

function initCanvas() {
    canvas = new fabric.Canvas('bbox-canvas');
    
    // Tải ảnh
    fabric.Image.fromURL('{{ distribution.observation_image.url }}', function(img) {
        currentImage = img;
        
        // Tính tỷ lệ để fit canvas
        const maxWidth = 800;
        const maxHeight = 600;
        let scale = 1;
        
        if (img.width > maxWidth || img.height > maxHeight) {
            scale = Math.min(maxWidth / img.width, maxHeight / img.height);
        }
        
        img.scale(scale);
        canvas.setWidth(img.width * scale);
        canvas.setHeight(img.height * scale);
        canvas.add(img);
        canvas.renderAll();
        
        // Load bboxes nếu có
        loadBBoxes();
    }, {
        crossOrigin: 'anonymous'
    });
    
    // Sự kiện cho nút thêm bbox
    document.getElementById('add-bbox').addEventListener('click', function() {
        addBBox();
    });
    
    // Sự kiện cho nút xóa tất cả
    document.getElementById('clear-bboxes').addEventListener('click', function() {
        if (confirm('Bạn có chắc muốn xóa tất cả bounding boxes?')) {
            clearBBoxes();
        }
    });
    
    // Sự kiện cho nút lưu bboxes
    document.getElementById('save-bboxes').addEventListener('click', function() {
        saveBBoxes();
    });
}

function loadBBoxes() {
    bboxes.forEach(function(bbox, index) {
        addBBoxToCanvas(bbox, index);
    });
    updateBBoxList();
}

function addBBoxToCanvas(bboxData, index) {
    if (!currentImage) return;
    
    const imgWidth = currentImage.width * currentImage.scaleX;
    const imgHeight = currentImage.height * currentImage.scaleY;
    
    const rect = new fabric.Rect({
        left: bboxData.x * imgWidth,
        top: bboxData.y * imgHeight,
        width: bboxData.width * imgWidth,
        height: bboxData.height * imgHeight,
        fill: 'rgba(255, 0, 0, 0.2)',
        stroke: 'red',
        strokeWidth: 2,
        selectable: true,
        hasControls: true,
        hasBorders: true,
        data: {
            index: index,
            label: bboxData.label || speciesLabel,
            confidence: bboxData.confidence || 0
        }
    });
    
    // Thêm text label - luôn dùng speciesLabel (eng_name)
    const labelText = bboxData.label || speciesLabel || `BBox ${index + 1}`;
    const text = new fabric.Text(labelText, {
        left: rect.left,
        top: rect.top - 20,
        fontSize: 14,
        fill: 'red',
        fontWeight: 'bold',
        backgroundColor: 'white',
        padding: 3
    });
    
    canvas.add(rect);
    canvas.add(text);
    
    // Khi bbox thay đổi
    rect.on('modified', function() {
        updateBBoxData(index);
        // Cập nhật vị trí text
        text.set({
            left: rect.left,
            top: rect.top - 20
        });
        canvas.renderAll();
    });
}

function addBBox() {
    if (!currentImage) return;
    
    const index = bboxes.length;
    const imgWidth = currentImage.width * currentImage.scaleX;
    const imgHeight = currentImage.height * currentImage.scaleY;
    
    // Tạo bbox mặc định ở giữa - luôn dùng speciesLabel (eng_name)
    const bboxData = {
        x: 0.25,
        y: 0.25,
        width: 0.5,
        height: 0.5,
        label: speciesLabel || `BBox ${index + 1}`,
        confidence: 0
    };
    
    bboxes.push(bboxData);
    addBBoxToCanvas(bboxData, index);
    updateBBoxList();
}

function updateBBoxData(index) {
    if (!currentImage || index >= bboxes.length) return;
    
    const objects = canvas.getObjects();
    const rect = objects.find(obj => obj.type === 'rect' && obj.data && obj.data.index === index);
    
    if (!rect) return;
    
    const imgWidth = currentImage.width * currentImage.scaleX;
    const imgHeight = currentImage.height * currentImage.scaleY;
    
    bboxes[index] = {
        x: rect.left / imgWidth,
        y: rect.top / imgHeight,
        width: rect.width * rect.scaleX / imgWidth,
        height: rect.height * rect.scaleY / imgHeight,
        label: rect.data.label || speciesLabel || `BBox ${index + 1}`,
        confidence: rect.data.confidence || 0
    };
    
    updateBBoxList();
}

function clearBBoxes() {
    // Xóa khỏi canvas
    const objects = canvas.getObjects();
    objects.forEach(obj => {
        if (obj.type === 'rect' || obj.type === 'text') {
            canvas.remove(obj);
        }
    });
    
    // Xóa khỏi mảng
    bboxes = [];
    updateBBoxList();
    canvas.renderAll();
}

function updateBBoxList() {
    const container = document.getElementById('bbox-items');
    container.innerHTML = '';
    
    bboxes.forEach(function(bbox, index) {
        const item = document.createElement('div');
        item.className = 'list-group-item bbox-item';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>BBox ${index + 1}</strong>
                    <span class="badge bg-primary ms-2">${bbox.label || speciesLabel || 'No label'}</span>
                    <br>
                    <small class="text-muted">
                        X: ${bbox.x.toFixed(4)}, Y: ${bbox.y.toFixed(4)}, 
                        W: ${bbox.width.toFixed(4)}, H: ${bbox.height.toFixed(4)}
                    </small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-warning me-2" onclick="editBBoxLabel(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBBox(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Thêm hàm chỉnh sửa nhãn
function editBBoxLabel(index) {
    const currentLabel = bboxes[index].label;
    const newLabel = prompt('Nhập nhãn mới cho BBox:', currentLabel);
    if (newLabel !== null) {
        bboxes[index].label = newLabel;
        
        // Cập nhật text trên canvas
        const objects = canvas.getObjects();
        const rect = objects.find(obj => obj.type === 'rect' && obj.data && obj.data.index === index);
        
        if (rect) {
            // Tìm text label tương ứng
            const texts = objects.filter(obj => obj.type === 'text');
            texts.forEach(text => {
                if (Math.abs(text.left - rect.left) < 10 && Math.abs(text.top - (rect.top - 20)) < 10) {
                    text.set('text', newLabel);
                }
            });
            
            // Cập nhật data label
            rect.data.label = newLabel;
        }
        
        updateBBoxList();
        canvas.renderAll();
    }
}

function deleteBBox(index) {
    if (confirm('Xóa bounding box này?')) {
        // Xóa khỏi canvas
        const objects = canvas.getObjects();
        const rect = objects.find(obj => obj.type === 'rect' && obj.data && obj.data.index === index);
        
        if (rect) {
            canvas.remove(rect);
            
            // Tìm và xóa text label tương ứng
            const texts = objects.filter(obj => obj.type === 'text');
            texts.forEach(text => {
                if (Math.abs(text.left - rect.left) < 10 && Math.abs(text.top - (rect.top - 20)) < 10) {
                    canvas.remove(text);
                }
            });
        }
        
        // Xóa khỏi mảng
        bboxes.splice(index, 1);
        
        // Cập nhật lại index
        objects.forEach(obj => {
            if (obj.data && obj.data.index > index) {
                obj.data.index -= 1;
            }
        });
        
        updateBBoxList();
        canvas.renderAll();
    }
}

function saveBBoxes() {
    const csrfToken = getCookie('csrftoken');
    
    fetch(`/admin_save_distribution/{{ distribution.id }}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ bboxes: bboxes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Đã lưu bounding boxes thành công!');
        } else {
            alert('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Lỗi khi lưu bounding boxes');
    });
}

// Hàm lấy CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Xác nhận khi từ chối
function confirmReject() {
    const comment = document.getElementById('comment').value;
    if (!comment.trim()) {
        alert('Vui lòng nhập lý do từ chối!');
        return false;
    }
    return confirm('Bạn có chắc chắn muốn từ chối vị trí này?');
}

// Lưu bboxes trước khi submit form
document.getElementById('review-form').addEventListener('submit', function(e) {
    // Gửi bboxes lên server nếu có
    if (bboxes.length > 0) {
        saveBBoxes();
    }
});
</script>
{% endblock %}