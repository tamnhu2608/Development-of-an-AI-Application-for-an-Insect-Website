{% extends 'template_v2.html' %}
{% load static %}

{% block title %}ƒê√≥ng g√≥p v·ªã tr√≠ c√¥n tr√πng{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt"></i> ƒê√≥ng g√≥p v·ªã tr√≠ c√¥n tr√πng
                    </h4>

                    <a href="{% url 'my_distribution_history' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-history"></i> L·ªãch s·ª≠ ƒë√≥ng g√≥p
                    </a>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        B·∫°n c√≥ th·ªÉ ƒë√≥ng g√≥p v·ªã tr√≠ c√¥n tr√πng b·∫±ng c√°ch:
                        <ul class="mb-0 mt-2">
                            <li>Ch·ª•p ·∫£nh tr·ª±c ti·∫øp (c√≥ GPS t·ª± ƒë·ªông)</li>
                            <li>T·∫£i ·∫£nh t·ª´ thi·∫øt b·ªã v√† nh·∫≠p t·ªça ƒë·ªô th·ªß c√¥ng</li>
                            <li>Nh·∫≠p th√¥ng tin quan s√°t v√† t·ªça ƒë·ªô</li>
                        </ul>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" id="distributionForm">
                        {% csrf_token %}
                        <input type="hidden" name="bbox_data" id="bboxData">
                                            
                        <!-- Ch·ª•p ·∫£nh ho·∫∑c t·∫£i ·∫£nh -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> 1. Ch·ª•p ho·∫∑c t·∫£i ·∫£nh</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <button type="button" class="btn btn-outline-primary mb-3" id="captureBtn">
                                                <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh tr·ª±c ti·∫øp
                                            </button>
                                            <div class="camera-preview mb-3" id="cameraPreview" style="display: none;">
                                                <video id="cameraView" width="100%" autoplay></video>
                                                <button type="button" class="btn btn-success mt-2" id="takePhotoBtn">
                                                    <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
                                                </button>
                                            </div>
                                            <canvas id="photoCanvas" style="display: none;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <label class="btn btn-outline-secondary mb-3" for="imageUpload">
                                                <i class="fas fa-upload"></i> T·∫£i ·∫£nh t·ª´ thi·∫øt b·ªã
                                            </label>
                                            <input type="file" 
                                                   id="imageUpload" 
                                                   name="observation_image" 
                                                   accept="image/*" 
                                                   capture="environment"
                                                   class="d-none">
                                            <div id="imagePreview" class="mt-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- L·∫•y v·ªã tr√≠ -->
                        <div class="mb-4">
                            <h5><i class="fas fa-location-dot"></i> 2. V·ªã tr√≠</h5>
                            <div class="alert alert-warning" id="locationAlert" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ t·ª± ƒë·ªông. Vui l√≤ng nh·∫≠p th·ªß c√¥ng ho·∫∑c cho ph√©p truy c·∫≠p v·ªã tr√≠.
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Vƒ© ƒë·ªô</label>
                                        <input type="number" 
                                               step="any" 
                                               class="form-control" 
                                               id="latitude" 
                                               name="latitude"
                                               placeholder="V√≠ d·ª•: 16.1666667"
                                               required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Kinh ƒë·ªô</label>
                                        <input type="number" 
                                               step="any" 
                                               class="form-control" 
                                               id="longitude" 
                                               name="longitude"
                                               placeholder="V√≠ d·ª•: 107.8333333"
                                               required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-info btn-sm" id="getLocationBtn">
                                    <i class="fas fa-location-crosshairs"></i> V·ªã tr√≠ hi·ªán t·∫°i
                                </button>
                                <small class="text-muted ms-2">(Y√™u c·∫ßu cho ph√©p truy c·∫≠p v·ªã tr√≠)</small>
                            </div>
                            <div id="mapPreview" style="height: 200px; border: 1px solid #ddd; border-radius: 5px;"></div>
                        </div>
                        <div class="mb-4" id="predictionBox" style="display:none;">
                            <h5><i class="fas fa-robot"></i> ƒê·ªÅ xu·∫•t c·ªßa h·ªá th·ªëng</h5>
                            <div id="predictionList"></div>
                            <small class="text-muted">
                                Ch·ªçn lo√†i ph√π h·ª£p nh·∫•t d·ª±a tr√™n ·∫£nh b·∫°n cung c·∫•p
                            </small>
                        </div>
                        <!-- Th√¥ng tin c∆° b·∫£n -->
                        <div class="mb-4">
                            <h5><i class="fas fa-info-circle"></i> 3. Th√¥ng tin quan s√°t</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Lo√†i c√¥n tr√πng *</label>
                                        <select class="form-select" name="species" id="speciesSelect" required disabled>

                                            <option value="">Ch·ªçn lo√†i...</option>
                                            {% for species in species_list %}
                                            <option value="{{ species.insects_id }}">
                                                {{ species.name }} ({{ species.ename }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Khu v·ª±c</label>
                                        <select class="form-select" name="region">
                                            <option value="">Ch·ªçn khu v·ª±c...</option>
                                            {% for region in regions %}
                                            <option value="{{ region.id }}">{{ region.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Ng√†y quan s√°t</label>
                                        <input type="date" class="form-control" name="observation_date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Th·ªùi gian</label>
                                        <input type="time" class="form-control" name="observation_time">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ghi ch√∫ (t√πy ch·ªçn)</label>
                                <textarea class="form-control" 
                                          name="note" 
                                          rows="3" 
                                          placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ quan s√°t..."></textarea>
                            </div>
                        </div>
                        
                        <!-- N√∫t g·ª≠i -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane"></i> G·ª≠i ƒë√≥ng g√≥p
                            </button>
                            <a href="{% url 'distribution_map' %}" class="btn btn-outline-secondary btn-lg ms-2">
                                <i class="fas fa-times"></i> H·ªßy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .camera-preview video {
        border: 2px solid #007bff;
        border-radius: 5px;
    }
    #mapPreview { margin-top: 10px; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map;
let marker;
let stream;

// Kh·ªüi t·∫°o b·∫£n ƒë·ªì xem tr∆∞·ªõc
function initMapPreview() {
    map = L.map('mapPreview').setView([16.1666667, 107.8333333], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Th√™m marker m·∫∑c ƒë·ªãnh
    marker = L.marker([16.1666667, 107.8333333])
        .addTo(map)
        .bindPopup('V·ªã tr√≠ ƒë√£ ch·ªçn')
        .openPopup();
    
    // X·ª≠ l√Ω click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ c·∫≠p nh·∫≠t v·ªã tr√≠
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        document.getElementById('latitude').value = lat.toFixed(6);
        document.getElementById('longitude').value = lng.toFixed(6);
        
        // C·∫≠p nh·∫≠t marker
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 12);
    });
}

// L·∫•y v·ªã tr√≠ hi·ªán t·∫°i
document.getElementById('getLocationBtn').addEventListener('click', function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lng.toFixed(6);
                
                // C·∫≠p nh·∫≠t b·∫£n ƒë·ªì
                marker.setLatLng([lat, lng]);
                map.setView([lat, lng], 15);
                
                // ·∫®n c·∫£nh b√°o n·∫øu c√≥
                document.getElementById('locationAlert').style.display = 'none';
            },
            function(error) {
                document.getElementById('locationAlert').style.display = 'block';
                console.error('Error getting location:', error);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        document.getElementById('locationAlert').style.display = 'block';
        alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation!');
    }
});

// X·ª≠ l√Ω ch·ª•p ·∫£nh
document.getElementById('captureBtn').addEventListener('click', async function() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } 
        });
        
        const video = document.getElementById('cameraView');
        video.srcObject = stream;
        document.getElementById('cameraPreview').style.display = 'block';
        document.getElementById('captureBtn').style.display = 'none';
        
    } catch (error) {
        alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + error.message);
    }
});

// Ch·ª•p ·∫£nh
document.getElementById('takePhotoBtn').addEventListener('click', function() {
    const video = document.getElementById('cameraView');
    const canvas = document.getElementById('photoCanvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Chuy·ªÉn canvas th√†nh blob v√† t·∫°o file input
    canvas.toBlob(function(blob) {
        const file = new File([blob], 'captured_photo.jpg', { type: 'image/jpeg' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        sendImageForPrediction(file);
        // T·∫°o input file ·∫©n v√† g√°n file
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'file';
        hiddenInput.name = 'observation_image';
        hiddenInput.files = dataTransfer.files;
        hiddenInput.style.display = 'none';
        
        // Th√™m v√†o form
        document.getElementById('distributionForm').appendChild(hiddenInput);
        
        // Hi·ªÉn th·ªã preview
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ƒê√£ ch·ª•p ·∫£nh th√†nh c√¥ng!
                <img src="${URL.createObjectURL(blob)}" class="img-thumbnail mt-2" style="max-height: 150px;">
            </div>
        `;
        
        // D·ª´ng camera
        stream.getTracks().forEach(track => track.stop());
        document.getElementById('cameraPreview').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'inline-block';
        
    }, 'image/jpeg');
});

// X·ª≠ l√Ω t·∫£i ·∫£nh
document.getElementById('imageUpload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ƒê√£ t·∫£i ·∫£nh l√™n!
                <img src="${URL.createObjectURL(file)}" class="img-thumbnail mt-2" style="max-height: 150px;">
            </div>
        `;
        
        // C·ªë g·∫Øng extract GPS t·ª´ ·∫£nh n·∫øu c√≥
        extractGPSFromImage(file);
        sendImageForPrediction(file);
    }
});

// Extract GPS t·ª´ ·∫£nh (n·∫øu c√≥)
function extractGPSFromImage(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        // C√≥ th·ªÉ s·ª≠ d·ª•ng th∆∞ vi·ªán nh∆∞ exif-js ƒë·ªÉ ƒë·ªçc metadata
        // ·ªû ƒë√¢y ch·ªâ l√† v√≠ d·ª• ƒë∆°n gi·∫£n
        console.log('Image loaded, could extract GPS here');
    };
    reader.readAsArrayBuffer(file);
}

// Kh·ªüi t·∫°o khi trang t·∫£i xong
document.addEventListener('DOMContentLoaded', initMapPreview);

function sendImageForPrediction(file) {
    const formData = new FormData();
    formData.append('image', file);

    fetch("{% url 'predict_species' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    })
    .then(res => res.json())
    .then(data => {
    const box = document.getElementById('predictionBox');
    const list = document.getElementById('predictionList');
    const select = document.getElementById('speciesSelect');
    if (data.bboxes && data.bboxes.length > 0) {
        window.detectedBoxes = data.bboxes;
    }
    list.innerHTML = '';
    select.innerHTML = '<option value="">Ch·ªçn lo√†i...</option>';

    box.style.display = 'block';

    /* 1Ô∏è‚É£ Hi·ªÉn th·ªã ·∫£nh bounding box */
    if (data.bbox_image) {
        list.innerHTML += `
            <div class="mb-3 text-center">
                <img src="${data.bbox_image}" class="img-fluid rounded border">
                <small class="text-muted d-block mt-1">
                    ·∫¢nh ƒë√£ ƒë∆∞·ª£c nh·∫≠n d·∫°ng
                </small>
            </div>
        `;
    }

    /* 2Ô∏è‚É£ Fallback n·∫øu AI kh√¥ng ch·∫Øc */
    if (data.fallback || !data.predictions || data.predictions.length === 0) {
        select.disabled = false;
        list.innerHTML += `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                AI ch∆∞a ƒë·ªß ch·∫Øc ch·∫Øn. Vui l√≤ng ch·ªçn lo√†i th·ªß c√¥ng b√™n d∆∞·ªõi.
            </div>
        `;
        return;
    }

    /* 3Ô∏è‚É£ Hi·ªÉn th·ªã TOP 3 lo√†i + ·∫£nh minh h·ªça */
    data.predictions.forEach(p => {
        list.innerHTML += `
            <div class="card mb-2">
                <div class="card-body d-flex align-items-center">
                    ${p.image ? `
                        <img src="${p.image}"
                             class="me-3 rounded border"
                             style="height:80px;width:auto;">
                    ` : ''}

                    <div>
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="radio"
                                   name="species_choice"
                                   onclick="selectSpecies(${p.id})">
                            <label class="form-check-label">
                                <b>${p.name}</b><br>
                                <small><i>${p.scientific_name}</i></small>
                            </label>
                        </div>

                        <span class="badge bg-success mt-1">
                            ${p.confidence}%
                        </span>
                    </div>
                </div>
            </div>
        `;

        select.innerHTML += `
            <option value="${p.id}">
                ${p.name} (${p.scientific_name})
            </option>
        `;
    });

    select.disabled = false;
});

}

function selectSpecies(id) {
    document.getElementById('speciesSelect').value = id;
}
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('distributionForm');
    const bboxInput = document.getElementById('bboxData');

    if (!form || !bboxInput) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y form ho·∫∑c bboxData');
        return;
    }

    form.addEventListener('submit', function () {

        if (!window.detectedBoxes || window.detectedBoxes.length === 0) {
            console.warn('‚ö†Ô∏è Kh√¥ng c√≥ bbox ƒë·ªÉ g·ª≠i');
            return;
        }

        // üëâ L·∫§Y ƒê√öNG ·∫¢NH ƒê√É HI·ªÇN TH·ªä BBOX
        const img = document.querySelector('#predictionList img');
        if (!img) {
            console.error('‚ùå Kh√¥ng t√¨m th·∫•y ·∫£nh bbox');
            return;
        }

        const imageWidth = img.naturalWidth;
        const imageHeight = img.naturalHeight;

        // üëâ CHU·∫®N H√ìA D·ªÆ LI·ªÜU G·ª¨I L√äN BACKEND
        const payload = window.detectedBoxes.map(box => ({
            x: box.x,
            y: box.y,
            width: box.width,
            height: box.height,
            confidence: box.confidence || 1,
            class: box.class || '',
            imageWidth: imageWidth,
            imageHeight: imageHeight
        }));

        bboxInput.value = JSON.stringify(payload);
        console.log('‚úÖ bbox g·ª≠i l√™n (CHU·∫®N):', bboxInput.value);
    });
});

</script>
{% endblock %}